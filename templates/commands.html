<html class="bg">
<!--Import all css, and images-->
<link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/materialize.css') }}">
<link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='GUI.css') }}">
<link rel="icon" type="image" href="{{ url_for('static',filename='icon.png') }}">
<!--Import datetime-->
<link href="https://www.jqueryscript.net/css/jquerysctipttop.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/4.0.0/flatly/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet"
    href="{{ url_for('static', filename='styles/datetimePicker/build/css/bootstrap-datetimepicker.min.css')}}">

<head>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <head>

    <body class="bg">
        <!-- Logo and top bar-->
        <nav class="mainNav">
            <div class="nav-wrapper">
                <img src="static/logo/logo.png" class="brand-logo" alt="Logo1" height="100%" width="5%">

                <ul id="nav-mobile" class="right hide-on-med-and-down">
                    <li><a href="/">Home</a></li>
                    <li><a href="control.html">Control</a></li>
                    <li><a href="about.html">Help and Feedback</a></li>
                </ul>
            </div>
        </nav>


        <!--Command list body(command table)-->
        <div bgcolor="#07224f" id="listBody">
            <!--Search inputs-->
            <input type="" id="commandInput" class="commandInput " onkeyup="searchNames()"
                placeholder="Search for names.." title="Type in a name">
            <input type="" id="numberInput" class="commandInput " onkeyup="searchNumbers()"
                placeholder="Search for ordered pair.." title="Type in an ordered pair">
            <br />
            <font face="Trebuchet MS" color="white">
                <!--Command table-->
                <table id="commandTable" class="commandTable" bgcolor="#102952">

                    <!--Headers, names-->
                    <tr class="header">
                        <th style="width:60%;color: white">Command</th>
                        <th style="width:40%;color: white">Command number</th>
                    </tr>

                    <!--Push command info to table, each cell contains command with type, subtype and name.-->
                    <!--Onclick add query variable to the end-->
                    {% for commandName in commandNames %}
                    <tr class="commandTr"
                        onclick="location.href = '?{{commandNumbers[commandNames.index(commandName)]}}'">
                        <td>{{commandName}}</td>
                        <td>{{commandNumbers[commandNames.index(commandName)]}}</td>
                    </tr>
                    {% endfor %}
                </table>
            </font>



        </div>
        <font face="Trebuchet MS" color="white">
            <div id="commandBody" style="display:none">


                <a href="#" class="sendButton" onclick="sendCommand()" id="button-3">إرسال أمر</a>

            </div>
        </font>
    </body>
    <style>
        .bg {
            background-color: #07224f
        }
    </style>


    <!-- Datetime librarys, JQuery bootstrap-->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.21.0/moment.min.js" type="text/javascript"></script>
    <script
        src="{{ url_for('static', filename='styles/datetimePicker/build/js/bootstrap-datetimepicker.min.js')}}"></script>

    <script type="text/javascript">
        $(function () {
            $('#datetimepicker1').datetimepicker();
        });
    </script>
    <script>

        var datetimeCounter = 0;
        var debug = "{{DEBUG}}";
        console.log("DEBUG: " + debug);

        var regex = new RegExp();
        var results = regex.exec(location.search);
        if (results.input.search("packet") != -1) {
            window.location.assign("?");
        }
        results = results.input.replace("?", "");
        results = results.replace("(", "");
        results = results.replace(")", "");
        results = results.split(",");
        if (results.length != 1) {
            document.getElementById("listBody").setAttribute("style", "display:none");
            document.getElementById("commandBody").setAttribute("style", "");
        }
        console.log(results);

        function writePacket(params, datetime) {
            if (datetime == 0) {
                datetime = new Date('January 1, 1970 00:00:00');
            }
            var packet = "{\"Type\":\"Telecommand\", \"Content\":";

            let dd = datetime.getDate();
            let mm = datetime.getMonth() + 1; //January is 0!
            let yyyy = datetime.getFullYear();
            let hours = datetime.getHours() + 1;
            let min = datetime.getMinutes() + 1;
            let sec = datetime.getSeconds() + 1;

            if (dd < 10) {
                dd = '0' + dd;
            }
            if (mm < 10) {
                mm = '0' + mm;
            }
            if (hours < 10) {
                hours = '0' + hours;
            }
            if (min < 10) {
                min = '0' + min;
            }
            if (sec < 10) {
                sec = '0' + sec;
            }
            let execTime = dd + '/' + mm + '/' + yyyy + " " + hours + ":" + min + ":" + sec;

            packet += "{\"ST\":\"" + results[0] + "\",\"SST\":\"" + results[1] + "\"" + ",\"ExecutionTime\":\"" + execTime + "\",\"Params\":{";
            for (var i = 0; i < params.length - 1; i++) {
                var arr = params[i];
                packet += "\"" + arr[0] + "\":\"" + arr[1] + "\",";

            }

            if (params.length > 0) {
                var arr = params[params.length - 1];
                packet += "\"" + arr[0] + "\":\"" + arr[1] + "\"";
            }


            packet += "}}}";
            console.log(packet)
            return packet;
        }


        function sendCommand() {
            var inputParams = document.getElementsByName("paramInput");
            var params = [];
            for (var i = 0; i < inputParams.length; i++) {
                var param = [];
                param.push(inputParams[i].getAttribute("paramName"));
                param.push(inputParams[i].lastElementChild.value);
                params.push(param);
            }
            var packet = [writePacket(params, 0)];
            sendPacket(packet);
        }

        function sendPacket(packets) {
            window.location.assign("?packet=[" + packets.toString() + "]");
            // Change URL to add query variable of (writePacket()).
        }

        function searchNames() {
            var input, filter, table, tr, td, i, txtValue, counter;
            input = document.getElementById("commandInput");
            filter = input.value.toUpperCase();
            table = document.getElementById("commandTable");
            tr = table.getElementsByTagName("tr");
            counter = true;
            for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[0];
                if (td) {
                    txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }
        function searchNumbers() {
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById("numberInput");
            filter = input.value.toUpperCase();
            table = document.getElementById("commandTable");
            tr = table.getElementsByTagName("tr");
            for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[1];
                if (td) {
                    txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }
        function validate(evt) {
            var theEvent = evt || window.event;

            // Handle paste
            if (theEvent.type === 'paste') {
                key = event.clipboardData.getData('text/plain');
            } else {
                // Handle key press
                var key = theEvent.keyCode || theEvent.which;
                key = String.fromCharCode(key);
            }
            var regex = /[0-9, -]|\./;
            if (!regex.test(key)) {
                theEvent.returnValue = false;
                if (theEvent.preventDefault) theEvent.preventDefault();
            }
        }
        function init() {
            searchNames();
            searchNumbers();
        }
        paramNames = [];
        {% for param in paramNames %}
        var commandParamNames = [];
        {% for name in param %}
        commandParamNames.push("{{name}}");
        {% endfor %}
        paramNames.push(commandParamNames);
        {% endfor %}

        paramTypes = [];
        {% for types in paramTypes %}
        commandParamTypes = [];
        {% for type in types %}
        commandParamTypes.push("{{type}}");
        {% endfor %}
        paramTypes.push(commandParamTypes);
        {% endfor %}

        paramUnits = [];
        {% for units in paramUnits %}
        commandParamUnits = [];
        {% for unit in units %}
        commandParamUnits.push("{{unit}}");
        {% endfor %}
        paramUnits.push(commandParamUnits);
        {% endfor %}
        commandNames = [];
        var dic = {};
        {% for commandName in commandNames %}
        commandNames.push("{{commandName}}");
        dic["{{commandNumbers[commandNames.index(commandName)]}}"] = "{{commandName}}";
        {% endfor %}

        function generateInput(type, paramName, paramUnit) {
            var inputContainer = document.createElement("div");
            inputContainer.setAttribute("style", "position:relative");
            inputContainer.setAttribute("name", "paramInput");
            inputContainer.setAttribute("paramName", paramName);

            var inputInfo = document.createElement("div");
            inputInfo.innerHTML = paramName + ((paramUnit == "None") ? " " : " In " + paramUnit) + ":";
            inputContainer.appendChild(inputInfo);

            var body = document.getElementById("commandBody");

            var intInput = document.createElement("input");
            intInput.setAttribute("maxlength", "5");
            //intInput.setAttribute("type", "numbers");
            intInput.setAttribute("onkeypress", "validate(event)");
            intInput.setAttribute("class", "paramsInput");

            var charInput = document.createElement("input");
            charInput.setAttribute("maxlength", "1");
            charInput.setAttribute("class", "paramsInput");

            var datetimeInput = document.createElement("input");
            datetimeInput.setAttribute("type", "text");
            datetimeInput.setAttribute("class", "form-control");
            datetimeInput.setAttribute("id", "datetime" + datetimeCounter.toString());

            var stringInput = document.createElement("input");
            stringInput.setAttribute("class", "paramInput movingLable");
            stringInput.setAttribute("style", "color: white");

            switch (type) {
                case ("uint16"):
                    inputContainer.appendChild(intInput);
                    console.log("Int input");
                    break;

                case ("uint32"):
                    inputContainer.appendChild(intInput);
                    console.log("Int input");
                    break;

                case ("string"):
                    inputContainer.appendChild(stringInput);
                    console.log("String input");
                    break;

                case ("byte"):
                    inputContainer.appendChild(charInput);
                    console.log("Char input");
                    break;

                case ("datetime"):
                    inputContainer.appendChild(datetimeInput);

                    $(function () {
                        $('#datetime' + datetimeCounter.toString()).datetimepicker();
                    });

                    console.log("Datetime ho no");
                    break;
                default:
                    console.log("Error!! Unknown type in MIB.xml parameter type '" + type.toString() + "'");
            }
            body.appendChild(inputContainer);
        }
        if (results.length == 2) {
            for (var i = 0; i < paramTypes[commandNames.indexOf(dic["(" + results[0] + "," + results[1] + ")"])].length; i++) {
                generateInput(paramTypes[commandNames.indexOf(dic["(" + results[0] + "," + results[1] + ")"])][i], paramNames[commandNames.indexOf(dic["(" + results[0] + "," + results[1] + ")"])][i], paramUnits[commandNames.indexOf(dic["(" + results[0] + "," + results[1] + ")"])][i]);
            }
        }
    </script>

    </body>

</html>