<!DOCTYPE html>
<html>
<!--Import all css, and images-->
<link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/materialize.css') }}">
<link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='GUI.css') }}">
<link rel="icon" type="image" href="{{ url_for('static',filename='icon.png') }}">
<!--Import datetime-->
<link href="https://www.jqueryscript.net/css/jquerysctipttop.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/4.0.0/flatly/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet"
    href="{{ url_for('static', filename='styles/datetimePicker/build/css/bootstrap-datetimepicker.min.css')}}">


<head>
    <title>Commands</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://cdn.rawgit.com/RubaXa/Sortable/master/Sortable.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="/static/js/side_bar.js"></script>

</head>

<body class="indigo darken-1">

    <ul id="slide-out" class="sidenav sidenav-fixed light-blue lighten-3">
        <li class="logo center-align">
            <img src="/static/logo/logo.png" class="brand-logo" height="200" width="200">
        </li>
        <li>
            <div style="margin-left: 30px; margin-right: 30px;" class="input-field">
                <input id="dump-seacrh" placeholder="Telemetry Name" class="autocomplete">
                <label for="dump-seacrh" class="active">Dump</label>
                <a class="waves-effect waves-light btn-small" onclick="searchDump('dump-seacrh')"><i
                        class="material-icons left">search</i> Search Dump</a>
            </div>
        </li>
        <li onclick="navChange(this)" class="active"><a href="/commands">Commands</a></li>
        <li onclick="navChange(this)"><a href="/beacon">Beacons</a></li>
        <li onclick="navChange(this)"><a href="/logs">Logs</a></li>
    </ul>

    <a href="#" data-target="slide-out" class="sidenav-trigger"><i class="material-icons">menu</i></a>


    <!--Command list body(command table)-->
    <main>
        <div bgcolor="#07224f" id="listBody">
            <!--Search inputs-->
            <input type="" id="nameInput" class="nameInput " onkeyup="searchNames()" placeholder="Search for names.."
                title="Type in a name">
            <input type="" id="numberInput" class="nameInput " onkeyup="searchNumbers()"
                placeholder="Search for ordered pair.." title="Type in an ordered pair">
            <br />
            <font face="Trebuchet MS" color="white">
                <!--Command table-->
                <div id="commandsContainer" class="commandsContainer">

                    <!--Headers, names-->
                    <div class="row commandsTitle">
                        <div class="column unselectable">Command</div>
                        <div class="column unselectable">Command number</div>
                    </div>


                    <!--Push command info to table, each cell contains command with type, subtype and name.-->
                    <!--Onclick add query variable to the end-->
                    {% for commandName in commandNames %}
                    <div class="row"
                        onclick="showParams(true); generateInputs{{commandNumbers[commandNames.index(commandName)]}};thisCommand=this;"
                        id="{{commandNumbers[commandNames.index(commandName)]}}">
                        <!--onclick="location.href = '?{{commandNumbers[commandNames.index(commandName)]}}'">-->
                        <div class="column unselectable">{{commandName}}</div>
                        <div class="column unselectable">{{commandNumbers[commandNames.index(commandName)]}}</div>
                    </div>
                    {% endfor %}
                </div>


                <div id="playlistContainer" class="playlistContainer">
                    <div class="row commandsTitle" value="HEADER">
                        <div class="column unselectable">Command</div>
                        <div class="column unselectable">Command number</div>
                    </div>
                </div>
                <button class="btn" onclick="sendPlaylist()">Send!</button>
                <input style="margin: 10px;" type="" id="playlistName" class="nameInput" placeholder="Playlist's name"
                    title="Type in a name">
                <button class="btn"
                    onclick="savePlaylist(document.getElementById('playlistName').value, playlist)">Save!</button>
                <select style="margin-bottom: 16px;" class="select-css" id="playlistNameOptions">
                </select>
                <button class="btn"
                    onclick="getPlaylist(options.options[options.selectedIndex].innerHTML)">Get!</button>
            </font>



        </div>
        <font face="Trebuchet MS" color="white">
            <div id="commandBody" style="display:none">


                <a href="#" class="sendButton" onclick="sendCommand()">Send Packet</a>
                <a href="#" class="addToPlaylistButton" onclick="addToPlaylist()" id="playlistButton">Add To
                    Playlist</a>

            </div>
        </font>
    </main>
</body>



<!-- Datetime librarys, JQuery bootstrap-->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.21.0/moment.min.js" type="text/javascript"></script>
<script
    src="{{ url_for('static', filename='styles/datetimePicker/build/js/bootstrap-datetimepicker.min.js')}}"></script>

<script type="text/javascript">
    $(function () {
        $('#datetimepicker1').datetimepicker({
            format: 'DD/MM/YYYY hh:mm:ss'
        });
    });
</script>

<!-- Firebase modules -->

<!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>

<!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
<script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-analytics.js"></script>

<!-- Add Firebase products that you want to use -->
<script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-database.js"></script>

<script>
    var playlistsNames = [];
    var lastPacket = null;
    var st = 0
    var sst = 0;
    var thisCommand = null;
    var datetimeCounter = 0;
    var debug = "{{DEBUG}}";
    console.log("DEBUG: " + debug);

    var regex = new RegExp();
    var results = regex.exec(location.search);
    if (results.input.search("packet") != -1) {
        window.location.assign("?");
        if (results.input.search("playlist")) {
            alert("This packet is going to playlist");
        }
    }
    results = results.input.replace("?", "");
    results = results.replace("(", "");
    results = results.replace(")", "");
    results = results.replace("&", ",");
    results = results.split(",");
    if (isInteger(results[0]) && isInteger(results[1])) {
        alert("yes");
        showParams(true);
        if (results.length == 3 && results[2] == "playlist") {
            alert("Playlist");

        }
        else {
            document.getElementById("playlistButton").setAttribute("style", "display:none");
        }
    }
    console.log(results);

    function showParams(show) {
        if (show) {
            document.getElementById("listBody").setAttribute("style", "display:none");
            document.getElementById("commandBody").setAttribute("style", "");
        }
        else {
            document.getElementById("listBody").setAttribute("style", "");
            document.getElementById("commandBody").setAttribute("style", "display:none");
        }
    }

    function writePacket(st, sst, params, datetime) {
        if (datetime == 0) {
            datetime = new Date('January 1, 1970 00:00:00');
        }
        var packet = "{\"Type\":\"Telecommand\", \"Content\":";

        let dd = datetime.getDate();
        let mm = datetime.getMonth() + 1; //January is 0!
        let yyyy = datetime.getFullYear();
        let hours = datetime.getHours() + 1;
        let min = datetime.getMinutes() + 1;
        let sec = datetime.getSeconds() + 1;

        if (dd < 10) {
            dd = '0' + dd;
        }
        if (mm < 10) {
            mm = '0' + mm;
        }
        if (hours < 10) {
            hours = '0' + hours;
        }
        if (min < 10) {
            min = '0' + min;
        }
        if (sec < 10) {
            sec = '0' + sec;
        }
        let execTime = dd + '/' + mm + '/' + yyyy + " " + hours + ":" + min + ":" + sec;

        packet += "{\"ST\":\"" + st + "\",\"SST\":\"" + sst + "\"" + ",\"ExecutionTime\":\"" + execTime + "\",\"Params\":{";
        for (var i = 0; i < params.length - 1; i++) {
            var arr = params[i];
            packet += "\"" + arr[0] + "\":\"" + arr[1] + "\",";

        }

        if (params.length > 0) {
            var arr = params[params.length - 1];
            packet += "\"" + arr[0] + "\":\"" + arr[1] + "\"";
        }


        packet += "}}}";
        return packet;
    }
    function clearInputs() {
        var body = document.getElementById("commandBody");
        var bodyChildren = body.children;
        var length = bodyChildren.length;
        for (var i = 0; i < bodyChildren.length; i++) {
            if (bodyChildren[i].tagName == "DIV") {
                bodyChildren[i].parentNode.removeChild(bodyChildren[i]);
                i--;
            }
        }
    }
    function isInteger(str) {
        var n = Math.floor(Number(str));
        return n !== Infinity && String(n) === str && n >= 0;
    }

    function sendCommand() {
        alert("Send command");
        var inputParams = document.getElementsByName("paramInput");
        var params = [];
        for (var i = 0; i < inputParams.length; i++) {
            var param = [];
            param.push(inputParams[i].getAttribute("paramName"));
            param.push(inputParams[i].lastElementChild.value);
            params.push(param);
        }
        var packet = writePacket(st, sst, params, 0);
        sendPacket(packet, true, null);
    }

    function addToPlaylist() {
        alert("Command added");
        var inputParams = document.getElementsByName("paramInput");
        var params = [];
        for (var i = 0; i < inputParams.length; i++) {
            var param = [];
            param.push(inputParams[i].getAttribute("paramName"));
            param.push(inputParams[i].lastElementChild.value);
            params.push(param);
        }
        var packet = writePacket(st, sst, params, 0);
        sendPacket(packet, false, thisCommand, params);
    }


    function sendPacket(packets, isNow, div, params) {
        showParams(false);
        if (isNow) {
            window.location.assign("?packet=[" + packets.toString() + "]");
            lastPacket = packets.toString();
            // Change URL to add query variable of (writePacket()).
        }
        else {
            let text = div.firstElementChild.innerHTML;
            paramsArr = params.toString().split(",");
            params = "";
            for (let i = 0; i < paramsArr.length; i += 2) {
                params += `${paramsArr[i]}: ${paramsArr[i + 1]}\n`;
            }
            div.firstElementChild.innerHTML = `<abbr title="${params}">${text}</abbr>`;
            div.setAttribute("value", packets);
        }
    }

    function searchNames() {
        var input, filter, table, trDiv, tdDiv, i, txtValue;
        input = document.getElementById("nameInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("commandsContainer");
        trDiv = table.getElementsByTagName("div");
        for (i = 1; i < trDiv.length; i++) {
            tdDiv = trDiv[i].getElementsByTagName("div")[0];
            if (tdDiv) {
                txtValue = tdDiv.textContent || tdDiv.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    trDiv[i].style.display = "";
                } else {
                    trDiv[i].style.display = "none";
                }
            }
        }
    }
    function searchNumbers() {
        var input, filter, table, trDiv, tdDiv, i, txtValue;
        input = document.getElementById("numberInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("commandsContainer");
        trDiv = table.getElementsByTagName("div");
        for (i = 1; i < trDiv.length; i++) {
            tdDiv = trDiv[i].getElementsByTagName("div")[1];
            if (tdDiv) {
                txtValue = tdDiv.textContent || tdDiv.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    trDiv[i].style.display = "";
                } else {
                    trDiv[i].style.display = "none";
                }
            }
        }
    }
    function validate(evt, type) {
        var theEvent = evt || window.event;
        switch (type) {
            case ("int"):
                // Handle paste
                if (theEvent.type === 'paste') {
                    key = event.clipboardData.getData('text/plain');
                } else {
                    // Handle key press
                    var key = theEvent.keyCode || theEvent.which;
                    key = String.fromCharCode(key);
                }
                var regex = /[0-9]/;
                if (!regex.test(key)) {
                    theEvent.returnValue = false;
                    if (theEvent.preventDefault) theEvent.preventDefault();
                }

                if (parseInt(theEvent.target.value) >= Number.MAX_SAFE_INTEGER) {
                    theEvent.returnValue = false;
                    theEvent.preventDefault();
                }
                break;
            case ("char"):
                // Handle paste
                if (theEvent.type === 'paste') {
                    key = event.clipboardData.getData('text/plain');
                } else {
                    // Handle key press
                    var key = theEvent.keyCode || theEvent.which;
                    key = String.fromCharCode(key);
                }
                var regex = /[0-9]/;
                if (!regex.test(key)) {
                    theEvent.returnValue = false;
                    if (theEvent.preventDefault) theEvent.preventDefault();
                }
                if (parseInt(theEvent.target.value + theEvent.key) > 255) {
                    theEvent.returnValue = false;
                    theEvent.preventDefault();
                }
                break;
        }
    }
    function init() {
        searchNames();
        searchNumbers();
    }
    paramNames = [];
    {% for param in paramNames %}
    var commandParamNames = [];
    {% for name in param %}
    commandParamNames.push("{{name}}");
    {% endfor %}
    paramNames.push(commandParamNames);
    {% endfor %}

    paramTypes = [];
    {% for types in paramTypes %}
    commandParamTypes = [];
    {% for type in types %}
    commandParamTypes.push("{{type}}");
    {% endfor %}
    paramTypes.push(commandParamTypes);
    {% endfor %}

    paramUnits = [];
    {% for units in paramUnits %}
    commandParamUnits = [];
    {% for unit in units %}
    commandParamUnits.push("{{unit}}");
    {% endfor %}
    paramUnits.push(commandParamUnits);
    {% endfor %}
    commandNames = [];
    var dic = {};
    {% for commandName in commandNames %}
    commandNames.push("{{commandName}}");
    dic["{{commandNumbers[commandNames.index(commandName)]}}"] = "{{commandName}}";
    {% endfor %}

    function generateInput(type, paramName, paramUnit) {
        var inputContainer = document.createElement("div");
        inputContainer.setAttribute("style", "position:relative");
        inputContainer.setAttribute("name", "paramInput");
        inputContainer.setAttribute("paramName", paramName);


        var inputInfo = document.createElement("div");
        inputInfo.innerHTML = paramName + ((paramUnit == "None") ? " " : " In " + paramUnit) + ":";
        inputContainer.appendChild(inputInfo);

        var body = document.getElementById("commandBody");

        var intInput = document.createElement("input");
        //intInput.setAttribute("type", "numbers");
        intInput.setAttribute("onkeypress", "validate(event, \"int\")");
        intInput.setAttribute("class", "paramsInput");

        var charInput = document.createElement("input");
        charInput.setAttribute("onkeypress", "validate(event, \"char\")");
        charInput.setAttribute("class", "paramsInput");

        var datetimeInput = document.createElement("input");
        datetimeInput.setAttribute("type", "text");
        datetimeInput.setAttribute("class", "form-control");
        datetimeInput.setAttribute("id", "datetime" + datetimeCounter.toString());

        var stringInput = document.createElement("input");
        stringInput.setAttribute("class", "paramInput movingLable");
        stringInput.setAttribute("style", "color: white");

        switch (type) {
            case ("uint16"):
                inputContainer.appendChild(intInput);
                console.log("Int input");
                break;

            case ("uint32"):
                inputContainer.appendChild(intInput);
                console.log("Int input");
                break;

            case ("string"):
                inputContainer.appendChild(stringInput);
                console.log("String input");
                break;

            case ("byte"):
                inputContainer.appendChild(charInput);
                console.log("Char input");
                break;

            case ("dateTime"):
                inputContainer.appendChild(datetimeInput);

                $(function () {
                    $('#datetime' + datetimeCounter.toString()).datetimepicker({
                        format: 'DD/MM/YYYY hh:mm:ss'
                    });
                });

                console.log("Datetime ho no");
                break;
            default:
                console.log("Error!! Unknown type in MIB.xml parameter type '" + type.toString() + "'");
        }
        body.appendChild(inputContainer);
    }
    function generateInputs(type, subtype) {
        st = type;
        sst = subtype;
        clearInputs();
        for (var i = 0; i < paramTypes[commandNames.indexOf(dic["(" + type + "," + subtype + ")"])].length; i++) {
            generateInput(paramTypes[commandNames.indexOf(dic["(" + type + "," + subtype + ")"])][i], paramNames[commandNames.indexOf(dic["(" + type + "," + subtype + ")"])][i], paramUnits[commandNames.indexOf(dic["(" + type + "," + subtype + ")"])][i]);
        }
    }
    if (results.length == 2 || results.length == 3) {

    }
    var e = 0;
    // Setup draggable columns
    new Sortable(commandsContainer, {
        group: {
            name: 'shared',
            pull: 'clone',
            put: false // Do not allow items to be put into this list
        },
        animation: 150,
        sort: false, // To disable sorting: set sort to false
        filter: '.commandsTitle',
        onEnd: (evt) => {
            evt.item.setAttribute("inlist", "true");
            e = evt;
        }
    });


    new Sortable(playlistContainer, {
        group: 'shared',
        animation: 150,
        filter: '.commandsTitle',
    });
    function sendPlaylist() {
        var playlist = document.getElementById("playlistContainer");
        var allCommands = "";
        var i = 0;
        while (i < playlist.children.length && playlist.children[i].getAttribute("value") != "HEADER") {
            i++;
        }
        i++;
        if (playlist.children.length <= i) {
            return;
        }
        for (; i < playlist.children.length - 1; i++) {
            var value = playlist.children[i].getAttribute("value");
            if (value == null) {
                alert("Command " + playlist.children[i].innerText + " is null");
            }
            else {
                allCommands += value + ",";
            }
        }
        var value = playlist.children[i].getAttribute("value");
        if (value == null) {
            alert("Command " + playlist.children[i].innerText + " is null");
        }
        else if (value == "HEADER") {

        }
        else {
            allCommands += value;
        }
        alert("All commands:" + allCommands);
        window.location.assign("?packet=[" + allCommands + "]")

    }
</script>

<script>
    var playlist = document.getElementById("playlistContainer");
    var x = "tryhard";
    var config = {
        apiKey: "AIzaSyDQWbidUuP-2zwyCsV9w3ylRnBRi2et_Zk",
        authDomain: "gsc-gui.firebaseapp.com",
        databaseURL: "https://gsc-gui.firebaseio.com",
        storageBucket: "bucket.appspot.com"
    };
    firebase.initializeApp(config);

    // Get a reference to the database service
    var database = firebase.database();
    var options = document.getElementById("playlistNameOptions")
    database.ref().once("value", function (snapshot) {
        snapshot.forEach(function (child) {
            var option = document.createElement("option");
            option.innerHTML = child.key;
            options.appendChild(option);
            console.log(child.key);
        })
    });

    function objToString(obj) {
        let str = "";
        for (key in obj) {
            str += `${key}: ${obj[key]}\n`
        }

        return str;
    }
    function getPlaylist(name, root) {

        var playlistPath = database.ref(name);
        var commandList = document.getElementById("playlistContainer");
        commandList.innerHTML = "<div class=\"row commandsTitle\" value=\"HEADER\"><div class=\"column unselectable\">Command</div><div class=\"column unselectable\">Command number</div></div>";

        playlistPath.once("value", function (snapshot) {
            snapshot.forEach(function (child) {
                console.log(child.key + ": " + child.val());
                child = child.val();
                var newCommand = document.createElement("div");
                newCommand.setAttribute("class", "row");
                newCommand.setAttribute("onclick", "showParams(true); generateInputs" + child["id"] + ";thisCommand=this;");
                newCommand.setAttribute("id", child["id"]);
                newCommand.setAttribute("draggable", "false");
                newCommand.setAttribute("inlist", "true");
                newCommand.setAttribute("value", child["value"]);
                var newCommandName = document.createElement("div");
                newCommandName.setAttribute("class", "column unselectable");
                params = objToString(JSON.parse(child["value"]).Content.Params);
                newCommandName.innerHTML = `<abbr title="${params}">${dic[child["id"]]}</abbr>`;
                var newCommandNumber = document.createElement("div");
                newCommandNumber.setAttribute("class", "column unselectable");
                newCommandNumber.innerHTML = child["id"];
                newCommand.appendChild(newCommandName);
                newCommand.appendChild(newCommandNumber);
                commandList.appendChild(newCommand);
            });
        });
    }
    function savePlaylist(name, root) {
        console.log("   Name: " + name);
        var playlistPath = database.ref(name);
        playlistPath.set({});
        var i = 0;
        while (i < root.children.length && root.children[i].getAttribute("value") != "HEADER") {
            i++;
        }
        i++;
        if (root.children.length <= i) {
            return;
        }
        for (; i < root.children.length - 1; i++) {
            var child = root.children[i];
            var id = child.getAttribute("id");
            var value = child.getAttribute("value");
            var json = {};
            json["id"] = id;
            json["value"] = value;
            playlistPath.push(json);
        }
        var child = root.children[i];
        var id = child.getAttribute("id");
        var value = child.getAttribute("value");

        var json = {};
        json["id"] = id;
        json["value"] = value;
        playlistPath.push(json);

    }

    function updatePlaylistNames() {
        var playlistPath = database.ref();
        var commandList = document.getElementById("playlistContainer");
        playlistPath.once("value", function (snapshot) {
            snapshot.forEach(function (child) {
                console.log(child.key + ": " + child.val());
                playlistsNames.push(child.key);

            });
        });
    }


</script>
</body>

</html>